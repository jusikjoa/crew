# Crew API 워크플로우 가이드

이 문서는 Crew 프로젝트의 각 API가 호출될 때 모듈 간 상호작용과 처리 절차를 시각적으로 설명합니다.

---

## 📋 목차

1. [공통 워크플로우](#공통-워크플로우)
2. [인증 API 워크플로우](#인증-api-워크플로우)
3. [사용자 API 워크플로우](#사용자-api-워크플로우)
4. [채널 API 워크플로우](#채널-api-워크플로우)
5. [메시지 API 워크플로우](#메시지-api-워크플로우)

---

## 공통 워크플로우

모든 API 요청은 다음 공통 워크플로우를 거칩니다:

### 처리 절차 설명

1. **HTTP 요청 수신**: 클라이언트(브라우저, 모바일 앱 등)가 HTTP 요청을 NestJS 애플리케이션으로 전송합니다.

2. **CORS 미들웨어 처리**: 
   - Cross-Origin Resource Sharing 설정을 확인합니다.
   - `origin: true`로 모든 origin을 허용합니다.
   - `credentials: true`로 쿠키 및 인증 정보를 허용합니다.
   - Preflight 요청(OPTIONS)을 처리합니다.

3. **ValidationPipe 처리**:
   - 전역 ValidationPipe가 요청 본문을 검증합니다.
   - `whitelist: true`로 DTO에 정의되지 않은 속성을 자동 제거합니다.
   - `transform: true`로 자동 타입 변환을 수행합니다 (예: 문자열 → 숫자).
   - 검증 실패 시 400 Bad Request를 반환합니다.

4. **라우팅**:
   - NestJS 라우터가 요청 경로를 분석하여 해당 Controller로 라우팅합니다.
   - URL 파라미터(`@Param`), 쿼리 파라미터(`@Query`), 요청 본문(`@Body`)을 추출합니다.

5. **인증 처리 (인증이 필요한 경우)**:
   - `@UseGuards(JwtAuthGuard)` 데코레이터가 적용된 경우에만 실행됩니다.
   - `Authorization` 헤더에서 `Bearer {token}` 형식의 토큰을 추출합니다.
   - JwtStrategy가 토큰을 검증합니다 (서명 확인, 만료 시간 확인).
   - 페이로드에서 사용자 정보(`sub`, `email`, `username`)를 추출합니다.
   - `validate()` 메서드를 실행하여 `request.user`에 사용자 정보를 주입합니다.
   - 인증 실패 시 401 Unauthorized를 반환합니다.

6. **Controller 메서드 실행**:
   - `@CurrentUser()` 데코레이터로 인증된 사용자 정보를 추출합니다.
   - DTO 검증이 완료된 요청 본문을 받습니다.
   - 해당 Service 메서드를 호출합니다.

7. **Service 로직 실행**:
   - 비즈니스 로직을 처리합니다.
   - 필요한 경우 다른 Service나 Repository를 호출합니다.
   - 데이터 검증 및 권한 체크를 수행합니다.
   - 예외가 발생하면 적절한 HTTP 상태 코드와 함께 예외를 던집니다.

8. **Repository 호출**:
   - TypeORM Repository를 통해 데이터베이스 쿼리를 실행합니다.
   - `find()`, `findOne()`, `save()`, `remove()` 등의 메서드를 사용합니다.

9. **데이터베이스 작업**:
   - SQLite 데이터베이스에 실제 쿼리가 실행됩니다.
   - SELECT, INSERT, UPDATE, DELETE 작업이 수행됩니다.

10. **응답 반환**:
    - 성공 시: Service에서 반환된 데이터를 DTO로 변환하여 JSON 응답으로 반환합니다.
    - 실패 시: 예외 핸들러가 예외를 HTTP 응답으로 변환합니다 (400, 401, 403, 404, 409, 500 등).

```
┌─────────────┐
│   Client    │
│  (Browser)  │
└──────┬──────┘
       │ HTTP Request
       ▼
┌─────────────────────────────────────┐
│         NestJS Application          │
│         (main.ts)                   │
│  ┌──────────────────────────────┐  │
│  │  1. CORS Middleware          │  │
│  │     - origin: true            │  │
│  │     - credentials: true       │  │
│  └──────────────┬─────────────────┘  │
│                 │                     │
│  ┌──────────────▼─────────────────┐  │
│  │  2. ValidationPipe            │  │
│  │     - whitelist: true         │  │
│  │     - transform: true         │  │
│  └──────────────┬─────────────────┘  │
│                 │                     │
│  ┌──────────────▼─────────────────┐  │
│  │  3. Router                     │  │
│  │     - Path matching            │  │
│  │     - Parameter extraction     │  │
│  └──────────────┬─────────────────┘  │
│                 │                     │
│       ┌─────────┴─────────┐           │
│       │ 인증 필요?        │           │
│       └─────────┬─────────┘           │
│                 │                     │
│    ┌────────────┴────────────┐        │
│    │                         │        │
│    ▼                         ▼        │
│ ┌─────────────────┐   ┌─────────────┐│
│ │ 4. JwtAuthGuard │   │ 4. Skip    ││
│ │    - Extract    │   │   Auth     ││
│ │      Token      │   │             ││
│ └────────┬────────┘   └──────┬──────┘│
│          │                   │        │
│    ┌─────▼─────┐             │        │
│    │ JwtStrategy│             │        │
│    │ - Verify  │             │        │
│    │ - Validate│             │        │
│    └─────┬─────┘             │        │
│          │                   │        │
│          └─────────┬──────────┘        │
│                   │                   │
│    ┌──────────────▼──────────────┐    │
│    │  5. Controller              │    │
│    │     - @CurrentUser()        │    │
│    │     - DTO Validation        │    │
│    └──────────────┬──────────────┘    │
│                   │                   │
│    ┌──────────────▼──────────────┐    │
│    │  6. Service                  │    │
│    │     - Business Logic        │    │
│    │     - Repository Call       │    │
│    └──────────────┬──────────────┘    │
│                   │                   │
│    ┌──────────────▼──────────────┐    │
│    │  7. Repository              │    │
│    │     - Database Query        │    │
│    └──────────────┬──────────────┘    │
│                   │                   │
│    ┌──────────────▼──────────────┐    │
│    │  8. Database (SQLite)        │    │
│    └──────────────┬──────────────┘    │
│                   │                   │
│          ┌────────┴────────┐          │
│          │                 │          │
│          ▼                 ▼          │
│    ┌──────────┐      ┌──────────┐    │
│    │ Success  │      │ Exception│    │
│    │ Response │      │ Handler  │    │
│    └────┬─────┘      └────┬─────┘    │
│         │                 │           │
│         └────────┬────────┘           │
│                  │                    │
└──────────────────┼────────────────────┘
                   │
                   ▼
            ┌─────────────┐
            │   Client    │
            │  (Response) │
            └─────────────┘
```

---

## 인증 API 워크플로우

### POST /auth/signup (회원가입)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `POST /auth/signup` 엔드포인트로 회원가입 정보를 전송합니다.
   - 필수 필드: `email`, `username`, `password`
   - 선택 필드: `displayName`

2. **ValidationPipe 검증**: `SignupDto`의 유효성을 검사합니다.
   - 이메일 형식 검증
   - 사용자명 길이 및 형식 검증
   - 비밀번호 강도 검증

3. **AuthService.signup() 호출**: 회원가입 비즈니스 로직을 처리합니다.

4. **사용자명 중복 확인**:
   - `UsersService.findByUsername()`을 호출하여 동일한 사용자명이 존재하는지 확인합니다.
   - 중복된 경우 `ConflictException` (409)을 발생시킵니다.

5. **비밀번호 해싱**:
   - `bcrypt.hash()`를 사용하여 평문 비밀번호를 해시화합니다.
   - `saltRounds: 10`을 사용하여 보안을 강화합니다.
   - 해시된 비밀번호는 데이터베이스에 저장됩니다.

6. **사용자 생성**:
   - `UsersService.create()`를 호출합니다.
   - 내부적으로 이메일 중복 확인을 수행합니다.
   - `User` 엔티티를 생성하고 `isActive: true`로 설정합니다.

7. **데이터베이스 저장**:
   - `UserRepository.save()`를 통해 SQLite 데이터베이스에 사용자 정보를 저장합니다.
   - INSERT 쿼리가 실행됩니다.

8. **응답 생성**:
   - 비밀번호를 제외한 사용자 정보를 `UserResponseDto`로 변환합니다.
   - 201 Created 상태 코드와 함께 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ POST /auth/signup
       │ { email, username, password, displayName }
       ▼
┌─────────────────────────────────────────────┐
│         AuthController.signup()              │
│  ┌──────────────────────────────────────┐   │
│  │ 1. ValidationPipe                    │   │
│  │    - SignupDto 검증                  │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. AuthService.signup()              │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ UsersService │  │   bcrypt     │         │
│  │ findByUsername│ │   .hash()    │         │
│  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │
│         │ 중복 확인       │ 비밀번호 해싱    │
│         │                 │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ UsersService     │                  │
│         │ .create()        │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ UserRepository  │                  │
│         │ .save()         │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │   SQLite DB      │                  │
│         │   INSERT User    │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ UserResponseDto  │                  │
│         │ (password 제외)  │                  │
│         └────────┬─────────┘                  │
└──────────────────┼──────────────────────────┘
                   │
                   ▼
            ┌─────────────┐
            │ 201 Created │
            │ User Data   │
            └─────────────┘
```

### POST /auth/login (로그인)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `POST /auth/login` 엔드포인트로 로그인 정보를 전송합니다.
   - 필수 필드: `emailOrUsername`, `password`

2. **ValidationPipe 검증**: `LoginDto`의 유효성을 검사합니다.

3. **AuthService.login() 호출**: 로그인 비즈니스 로직을 처리합니다.

4. **사용자 찾기**:
   - 먼저 `UsersService.findByEmail()`을 호출하여 이메일로 사용자를 찾습니다.
   - 실패 시 `UsersService.findByUsername()`을 호출하여 사용자명으로 사용자를 찾습니다.
   - 사용자를 찾지 못한 경우 `UnauthorizedException` (401)을 발생시킵니다.

5. **계정 활성화 상태 확인**:
   - `user.isActive === false`인 경우 `UnauthorizedException` (401)을 발생시킵니다.
   - 비활성화된 계정은 로그인할 수 없습니다.

6. **비밀번호 확인**:
   - `bcrypt.compare()`를 사용하여 입력된 비밀번호와 저장된 해시 비밀번호를 비교합니다.
   - 비밀번호가 일치하지 않으면 `UnauthorizedException` (401)을 발생시킵니다.

7. **JWT 토큰 생성**:
   - 페이로드에 `{ sub: user.id, email: user.email, username: user.username }`을 포함합니다.
   - `JwtService.sign()`을 사용하여 토큰을 생성합니다.
   - 기본 만료 시간은 1일입니다.

8. **응답 생성**:
   - 비밀번호를 제외한 사용자 정보와 `accessToken`을 포함한 `LoginResponseDto`를 생성합니다.
   - 200 OK 상태 코드와 함께 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ POST /auth/login
       │ { emailOrUsername, password }
       ▼
┌─────────────────────────────────────────────┐
│         AuthController.login()              │
│  ┌──────────────────────────────────────┐   │
│  │ 1. ValidationPipe                    │   │
│  │    - LoginDto 검증                  │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. AuthService.login()               │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ UsersService │  │ UsersService │         │
│  │ findByEmail │  │ findByUsername│        │
│  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │
│         │ 실패 시         │                  │
│         └────────┬────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ User 조회 완료   │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ isActive 확인    │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ bcrypt.compare() │                  │
│         │ 비밀번호 검증    │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ JwtService      │                  │
│         │ .sign()         │                  │
│         │ 토큰 생성       │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ LoginResponseDto │                  │
│         │ { user, token }  │                  │
│         └────────┬─────────┘                  │
└──────────────────┼──────────────────────────┘
                   │
                   ▼
            ┌─────────────┐
            │  200 OK     │
            │ User + Token│
            └─────────────┘
```

---

## 사용자 API 워크플로우

### GET /users (모든 사용자 조회)

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ GET /users
       ▼
┌─────────────────────────────────────────────┐
│      UsersController.findAll()              │
│  ┌──────────────────────────────────────┐   │
│  │ UsersService.findAll()              │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ UserRepository.find()               │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ SQLite DB                            │   │
│  │ SELECT * FROM users                  │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ User[] → UserResponseDto[]           │   │
│  │ (password 제외)                       │   │
│  └──────────────┬───────────────────────┘   │
└──────────────────┼──────────────────────────┘
                   │
                   ▼
            ┌─────────────┐
            │  200 OK     │
            │ User List   │
            └─────────────┘
```

### POST /users (사용자 생성)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `POST /users` 엔드포인트로 사용자 정보를 전송합니다.
   - 인증이 필요하지 않습니다 (일반적으로는 `/auth/signup` 사용 권장).

2. **ValidationPipe 검증**: `CreateUserDto`의 유효성을 검사합니다.
   - 이메일 형식 검증
   - 사용자명 형식 검증
   - 비밀번호 강도 검증

3. **UsersService.create() 호출**: 사용자 생성 비즈니스 로직을 처리합니다.

4. **이메일 중복 확인**:
   - `UserRepository.findOne({ where: { email } })`를 실행하여 동일한 이메일이 존재하는지 확인합니다.
   - 중복된 경우 `ConflictException` (409)을 발생시킵니다.

5. **사용자 엔티티 생성**:
   - `UserRepository.create()`를 사용하여 User 엔티티를 생성합니다.
   - `isActive: true`로 설정하여 계정을 활성화 상태로 만듭니다.

6. **데이터베이스 저장**:
   - `UserRepository.save()`를 통해 SQLite 데이터베이스에 사용자 정보를 저장합니다.
   - 비밀번호는 이미 해시된 상태로 저장됩니다.

7. **응답 생성**:
   - 비밀번호를 제외한 사용자 정보를 `UserResponseDto`로 변환합니다.
   - 201 Created 상태 코드와 함께 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ POST /users
       │ { email, username, password, ... }
       ▼
┌─────────────────────────────────────────────┐
│      UsersController.create()               │
│  ┌──────────────────────────────────────┐   │
│  │ 1. ValidationPipe                    │   │
│  │    - CreateUserDto 검증              │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. UsersService.create()             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 3. UserRepository.findOne()          │   │
│  │    - 이메일 중복 확인                │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 중복 있음    │  │ 중복 없음    │         │
│  │ 409 Conflict │  │ 계속 진행    │         │
│  └──────────────┘  └──────┬───────┘         │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ UserRepository    │        │
│                  │ .create() + .save()│       │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ SQLite DB         │        │
│                  │ INSERT User       │        │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ UserResponseDto   │        │
│                  └─────────┬─────────┘        │
└────────────────────────────┼──────────────────┘
                             │
                             ▼
                      ┌─────────────┐
                      │ 201 Created │
                      └─────────────┘
```

---

## 채널 API 워크플로우

### POST /channels (채널 생성)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `POST /channels` 엔드포인트로 채널 정보를 전송합니다.
   - 인증이 필요합니다: `Authorization: Bearer {token}` 헤더 필수
   - 필수 필드: `name`, `description`, `isPublic`
   - 선택 필드: `password` (비공개 채널인 경우), `isDM`, `recipientId` (DM 채널인 경우)

2. **JwtAuthGuard 실행**: 인증을 처리합니다.
   - `Authorization` 헤더에서 Bearer 토큰을 추출합니다.
   - JwtStrategy로 토큰을 검증합니다.
   - `@CurrentUser()` 데코레이터로 사용자 정보(`userId`, `email`, `username`)를 추출합니다.

3. **ValidationPipe 검증**: `CreateChannelDto`의 유효성을 검사합니다.
   - 채널명 형식 및 길이 검증
   - 설명 길이 검증
   - DM 채널인 경우 `recipientId` 필수 확인

4. **ChannelsService.create() 호출**: 채널 생성 비즈니스 로직을 처리합니다.

5. **채널명 중복 확인**:
   - `ChannelRepository.findOne({ where: { name } })`를 실행하여 동일한 채널명이 존재하는지 확인합니다.
   - 중복된 경우 `ConflictException` (409)을 발생시킵니다.

6. **비밀번호 해싱** (제공된 경우):
   - 비밀번호가 제공된 경우 `bcrypt.hash()`를 사용하여 해시화합니다.
   - 해시된 비밀번호는 데이터베이스에 저장됩니다.

7. **채널 엔티티 생성 및 저장**:
   - `ChannelRepository.create()`를 사용하여 Channel 엔티티를 생성합니다.
   - `createdBy` 필드에 현재 사용자의 `userId`를 설정합니다.
   - `ChannelRepository.save()`를 통해 SQLite 데이터베이스에 저장합니다.

8. **DM 채널 처리** (`isDM === true`인 경우):
   - `recipientId`가 제공되었는지 확인합니다.
   - 생성자와 상대방이 같은 사용자가 아닌지 확인합니다.
   - 생성자와 상대방 사용자를 모두 조회합니다.
   - 두 사용자를 모두 채널의 `members`에 추가합니다.
   - 각 사용자의 `channels` 관계에도 채널을 추가합니다.

9. **일반 채널 처리** (`isDM === false`인 경우):
   - 채널 생성자를 자동으로 채널 멤버에 추가합니다.
   - 생성자의 `channels` 관계에도 채널을 추가합니다.

10. **응답 생성**:
    - 비밀번호를 제외한 채널 정보를 `ChannelResponseDto`로 변환합니다.
    - 201 Created 상태 코드와 함께 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ POST /channels
       │ Authorization: Bearer {token}
       │ { name, description, isPublic, password, isDM, recipientId }
       ▼
┌─────────────────────────────────────────────┐
│      ChannelsController.create()            │
│  ┌──────────────────────────────────────┐   │
│  │ 1. JwtAuthGuard                      │   │
│  │    - 토큰 검증                       │   │
│  │    - @CurrentUser() 추출             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. ValidationPipe                    │   │
│  │    - CreateChannelDto 검증           │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 3. ChannelsService.create()          │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ ChannelRepo  │  │   bcrypt     │         │
│  │ findOne()   │  │   .hash()    │         │
│  │ 중복 확인   │  │ 비밀번호 해싱│         │
│  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ ChannelRepository│                  │
│         │ .create() + .save()│                │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ SQLite DB        │                  │
│         │ INSERT Channel   │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ isDM 확인        │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────┴────────┐                  │
│         │                 │                  │
│         ▼                 ▼                  │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ DM 채널      │  │ 일반 채널    │         │
│  │ - recipientId│  │ - 생성자만  │         │
│  │   확인       │  │   멤버 추가  │         │
│  │ - 두 사용자  │  │             │         │
│  │   멤버 추가  │  │             │         │
│  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │
│         └────────┬─────────┘                  │
│                  │                            │
│         ┌────────▼─────────┐                  │
│         │ ChannelResponseDto│                  │
│         │ (password 제외)  │                  │
│         └────────┬─────────┘                  │
└──────────────────┼──────────────────────────┘
                   │
                   ▼
            ┌─────────────┐
            │ 201 Created │
            │ Channel Data│
            └─────────────┘
```

### POST /channels/:id/join (채널 참여)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `POST /channels/:id/join` 엔드포인트로 채널 참여 요청을 전송합니다.
   - 인증이 필요합니다: `Authorization: Bearer {token}` 헤더 필수
   - URL 파라미터: `id` (채널 ID)
   - 요청 본문: `{ password? }` (비공개 채널인 경우 비밀번호 필요)

2. **JwtAuthGuard 실행**: 인증을 처리합니다.
   - `@CurrentUser()` 데코레이터로 사용자 정보를 추출합니다.

3. **ChannelsService.joinChannel() 호출**: 채널 참여 비즈니스 로직을 처리합니다.

4. **채널 조회**:
   - `ChannelRepository.findOne()`을 실행하여 채널을 조회합니다.
   - `relations: ['members']`로 멤버 관계를 함께 로드합니다.
   - 채널이 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.

5. **비공개 채널 비밀번호 검증** (`isPublic === false`인 경우):
   - 채널에 비밀번호가 설정되어 있는지 확인합니다.
   - 비밀번호가 설정된 경우:
     - 요청 본문에 비밀번호가 없으면 `UnauthorizedException` (401)을 발생시킵니다.
     - `bcrypt.compare()`를 사용하여 비밀번호를 검증합니다.
     - 비밀번호가 일치하지 않으면 `UnauthorizedException` (401)을 발생시킵니다.
   - 비밀번호가 설정되지 않은 비공개 채널인 경우:
     - `ForbiddenException` (403)을 발생시킵니다 (참여 불가).

6. **사용자 조회**:
   - `UserRepository.findOne()`을 실행하여 현재 사용자를 조회합니다.
   - 사용자가 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.

7. **이미 참여 중인지 확인**:
   - `channel.members` 배열에 현재 사용자가 포함되어 있는지 확인합니다.
   - 이미 멤버인 경우 `ConflictException` (409)을 발생시킵니다.

8. **채널에 사용자 추가**:
   - `channel.members.push(user)`를 실행하여 사용자를 멤버 목록에 추가합니다.
   - `ChannelRepository.save()`를 통해 변경사항을 데이터베이스에 저장합니다.
   - Many-to-Many 관계가 자동으로 업데이트됩니다.

9. **응답 생성**:
   - 업데이트된 채널 정보를 `ChannelResponseDto`로 변환합니다.
   - 200 OK 상태 코드와 함께 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ POST /channels/:id/join
       │ Authorization: Bearer {token}
       │ { password? }
       ▼
┌─────────────────────────────────────────────┐
│   ChannelsController.joinChannel()           │
│  ┌──────────────────────────────────────┐   │
│  │ 1. JwtAuthGuard                      │   │
│  │    - @CurrentUser() 추출             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. ChannelsService.joinChannel()     │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 3. ChannelRepository.findOne()       │   │
│  │    - relations: ['members']          │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 채널 없음    │  │ 채널 있음    │         │
│  │ 404 Not Found│  │ 계속 진행    │         │
│  └──────────────┘  └──────┬───────┘         │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ isPublic 확인     │        │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────┴─────────┐        │
│                  │                   │        │
│                  ▼                   ▼        │
│          ┌──────────────┐   ┌──────────────┐  │
│          │ 비공개 채널  │   │ 공개 채널   │  │
│          │ 비밀번호 검증│   │ 바로 참여    │  │
│          └──────┬───────┘   └──────┬───────┘  │
│                 │                  │          │
│         ┌───────┴───────┐         │          │
│         │               │         │          │
│         ▼               ▼         │          │
│  ┌──────────────┐  ┌──────────────┐│          │
│  │ bcrypt.compare│ │ 비밀번호 틀림││          │
│  │ 비밀번호 맞음│ │ 401 Unauthorized│        │
│  └──────┬───────┘  └──────────────┘│          │
│         │                  │          │
│         └────────┬─────────┘          │
│                  │                    │
│         ┌────────▼─────────┐          │
│         │ 이미 멤버 확인   │          │
│         └────────┬─────────┘          │
│                  │                    │
│         ┌────────┴────────┐           │
│         │                 │           │
│         ▼                 ▼           │
│  ┌──────────────┐  ┌──────────────┐   │
│  │ 이미 멤버    │  │ 멤버 아님    │   │
│  │ 409 Conflict │  │ 멤버 추가    │   │
│  └──────────────┘  └──────┬───────┘   │
│                            │          │
│                  ┌─────────▼─────────┐│
│                  │ channel.members   ││
│                  │ .push(user)       ││
│                  │ .save()           ││
│                  └─────────┬─────────┘│
│                            │          │
│                  ┌─────────▼─────────┐│
│                  │ ChannelResponseDto││
│                  └─────────┬─────────┘│
└────────────────────────────┼──────────┘
                             │
                             ▼
                      ┌─────────────┐
                      │  200 OK     │
                      └─────────────┘
```

---

## 메시지 API 워크플로우

### POST /messages (메시지 생성)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `POST /messages` 엔드포인트로 메시지 정보를 전송합니다.
   - 인증이 필요합니다: `Authorization: Bearer {token}` 헤더 필수
   - 필수 필드: `content` (메시지 내용), `channelId` (채널 ID)

2. **JwtAuthGuard 실행**: 인증을 처리합니다.
   - `@CurrentUser()` 데코레이터로 사용자 정보(`userId`)를 추출합니다.

3. **ValidationPipe 검증**: `CreateMessageDto`의 유효성을 검사합니다.
   - 메시지 내용 길이 검증
   - 채널 ID 형식 검증

4. **MessagesService.create() 호출**: 메시지 생성 비즈니스 로직을 처리합니다.

5. **채널 존재 확인 및 멤버 확인**:
   - `ChannelRepository.findOne()`을 실행하여 채널을 조회합니다.
   - `relations: ['members']`로 멤버 관계를 함께 로드합니다.
   - 채널이 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.
   - `channel.members` 배열에 현재 사용자가 포함되어 있는지 확인합니다.
   - 사용자가 채널 멤버가 아니면 `ForbiddenException` (403)을 발생시킵니다.

6. **작성자 존재 확인**:
   - `UserRepository.findOne()`을 실행하여 현재 사용자를 조회합니다.
   - 사용자가 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.

7. **메시지 생성 및 저장**:
   - `MessageRepository.create()`를 사용하여 Message 엔티티를 생성합니다.
   - `authorId`, `channelId`, `content`를 설정합니다.
   - `MessageRepository.save()`를 통해 SQLite 데이터베이스에 저장합니다.
   - INSERT 쿼리가 실행됩니다.

8. **관계 로드**:
   - `MessageRepository.findOne()`을 실행하여 생성된 메시지를 다시 조회합니다.
   - `relations: ['author', 'channel']`로 작성자와 채널 관계를 함께 로드합니다.
   - 이는 응답에 작성자 정보와 채널 정보를 포함하기 위함입니다.

9. **DTO 변환**:
   - `toResponseDto()` 메서드를 사용하여 `MessageResponseDto`를 생성합니다.
   - 작성자 정보를 포함하되 비밀번호는 제외합니다.
   - 채널 정보도 포함합니다.

10. **WebSocket 브로드캐스트**:
    - `MessagesGateway.broadcastNewMessage()`를 호출합니다.
    - 해당 채널의 모든 연결된 WebSocket 클라이언트에 새 메시지 알림을 전송합니다.
    - `socket.to(\`channel-${channelId}\`).emit('newMessage', message)` 형식으로 브로드캐스트됩니다.

11. **응답 반환**: 201 Created 상태 코드와 함께 메시지 정보를 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ POST /messages
       │ Authorization: Bearer {token}
       │ { content, channelId }
       ▼
┌─────────────────────────────────────────────┐
│      MessagesController.create()             │
│  ┌──────────────────────────────────────┐   │
│  │ 1. JwtAuthGuard                      │   │
│  │    - @CurrentUser() 추출             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. ValidationPipe                    │   │
│  │    - CreateMessageDto 검증           │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 3. MessagesService.create()          │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ ChannelRepo  │  │ UserRepo     │         │
│  │ findOne()    │  │ findOne()    │         │
│  │ + members    │  │ 작성자 확인  │         │
│  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │
│         │ 멤버 확인       │                  │
│         │                 │                  │
│         └────────┬────────┘                  │
│                  │                            │
│         ┌────────┴────────┐                  │
│         │                 │                  │
│         ▼                 ▼                  │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 멤버 아님    │  │ 멤버임       │         │
│  │ 403 Forbidden│  │ 계속 진행    │         │
│  └──────────────┘  └──────┬───────┘         │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ MessageRepository │        │
│                  │ .create() + .save()│      │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ SQLite DB         │        │
│                  │ INSERT Message    │        │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ MessageRepository │        │
│                  │ findOne()         │        │
│                  │ + relations       │        │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ MessageResponseDto│        │
│                  │ 변환              │        │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ MessagesGateway   │        │
│                  │ broadcastNewMessage│       │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ WebSocket Clients │        │
│                  │ emit('newMessage')│        │
│                  └─────────┬─────────┘        │
└────────────────────────────┼──────────────────┘
                             │
                             ▼
                      ┌─────────────┐
                      │ 201 Created │
                      │ Message Data│
                      └─────────────┘
```

### GET /messages/channel/:channelId (채널별 메시지 조회)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `GET /messages/channel/:channelId` 엔드포인트로 요청을 전송합니다.
   - 인증이 필요합니다: `Authorization: Bearer {token}` 헤더 필수
   - URL 파라미터: `channelId` (채널 ID)

2. **JwtAuthGuard 실행**: 인증을 처리합니다.
   - `@CurrentUser()` 데코레이터로 사용자 정보를 추출합니다.

3. **MessagesService.findByChannel() 호출**: 채널별 메시지 조회 비즈니스 로직을 처리합니다.

4. **채널 존재 확인 및 멤버 확인**:
   - `ChannelRepository.findOne()`을 실행하여 채널을 조회합니다.
   - `relations: ['members']`로 멤버 관계를 함께 로드합니다.
   - 채널이 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.
   - `channel.members` 배열에 현재 사용자가 포함되어 있는지 확인합니다.
   - 사용자가 채널 멤버가 아니면 `ForbiddenException` (403)을 발생시킵니다.

5. **메시지 조회**:
   - `MessageRepository.find()`를 실행하여 해당 채널의 모든 메시지를 조회합니다.
   - `where: { channelId }` 조건으로 특정 채널의 메시지만 필터링합니다.
   - `relations: ['author', 'channel']`로 작성자와 채널 관계를 함께 로드합니다.
   - `order: { createdAt: 'ASC' }`로 생성일 기준 오름차순 정렬합니다 (오래된 메시지부터).

6. **DTO 변환**:
   - 각 메시지를 `MessageResponseDto`로 변환합니다.
   - 작성자 정보를 포함하되 비밀번호는 제외합니다.
   - 채널 정보도 포함합니다.

7. **응답 반환**: 200 OK 상태 코드와 함께 메시지 목록을 반환합니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ GET /messages/channel/:channelId
       │ Authorization: Bearer {token}
       ▼
┌─────────────────────────────────────────────┐
│   MessagesController.findByChannel()         │
│  ┌──────────────────────────────────────┐   │
│  │ 1. JwtAuthGuard                      │   │
│  │    - @CurrentUser() 추출             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. MessagesService.findByChannel()   │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 3. ChannelRepository.findOne()       │   │
│  │    - relations: ['members']          │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 채널 없음    │  │ 멤버 아님    │         │
│  │ 404 Not Found│  │ 403 Forbidden│         │
│  └──────────────┘  └──────────────┘         │
│                            │                 │
│                  ┌─────────▼─────────┐       │
│                  │ 멤버임            │       │
│                  │ 계속 진행         │       │
│                  └─────────┬─────────┘       │
│                            │                 │
│                  ┌─────────▼─────────┐       │
│                  │ MessageRepository │       │
│                  │ .find()           │       │
│                  │ where: { channelId }│     │
│                  │ relations: [author, channel]│
│                  │ order: ASC        │       │
│                  └─────────┬─────────┘       │
│                            │                 │
│                  ┌─────────▼─────────┐       │
│                  │ SQLite DB         │       │
│                  │ SELECT * FROM messages│    │
│                  │ WHERE channelId = ?│      │
│                  └─────────┬─────────┘       │
│                            │                 │
│                  ┌─────────▼─────────┐       │
│                  │ Message[]         │       │
│                  │ → MessageResponseDto[]│    │
│                  └─────────┬─────────┘       │
└────────────────────────────┼──────────────────┘
                             │
                             ▼
                      ┌─────────────┐
                      │  200 OK     │
                      │ Message List│
                      └─────────────┘
```

### DELETE /messages/:id (메시지 삭제)

#### 처리 절차 설명

1. **요청 수신**: 클라이언트가 `DELETE /messages/:id` 엔드포인트로 메시지 삭제 요청을 전송합니다.
   - 인증이 필요합니다: `Authorization: Bearer {token}` 헤더 필수
   - URL 파라미터: `id` (메시지 ID)

2. **JwtAuthGuard 실행**: 인증을 처리합니다.
   - `@CurrentUser()` 데코레이터로 사용자 정보(`userId`)를 추출합니다.

3. **MessagesService.remove() 호출**: 메시지 삭제 비즈니스 로직을 처리합니다.

4. **메시지 조회**:
   - `MessageRepository.findOne()`을 실행하여 메시지를 조회합니다.
   - `relations: ['channel']`로 채널 관계를 함께 로드합니다.
   - 메시지가 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.

5. **권한 체크**:
   - `message.authorId`와 현재 사용자의 `userId`를 비교합니다.
   - 일치하지 않으면 `ForbiddenException` (403)을 발생시킵니다.
   - 메시지는 작성자만 삭제할 수 있습니다.

6. **채널 멤버 확인**:
   - 메시지의 채널을 조회합니다.
   - `ChannelRepository.findOne()`을 실행하여 채널을 조회합니다.
   - `relations: ['members']`로 멤버 관계를 함께 로드합니다.
   - 채널이 존재하지 않으면 `NotFoundException` (404)을 발생시킵니다.
   - `channel.members` 배열에 현재 사용자가 포함되어 있는지 확인합니다.
   - 사용자가 채널 멤버가 아니면 `ForbiddenException` (403)을 발생시킵니다.

7. **메시지 삭제**:
   - `channelId`와 `messageId`를 저장합니다 (WebSocket 브로드캐스트에 필요).
   - `MessageRepository.remove()`를 실행하여 메시지를 데이터베이스에서 삭제합니다.
   - DELETE 쿼리가 실행됩니다.

8. **WebSocket 브로드캐스트**:
   - `MessagesGateway.broadcastDeletedMessage()`를 호출합니다.
   - 해당 채널의 모든 연결된 WebSocket 클라이언트에 메시지 삭제 알림을 전송합니다.
   - `socket.to(\`channel-${channelId}\`).emit('deletedMessage', { messageId })` 형식으로 브로드캐스트됩니다.

9. **응답 반환**: 204 No Content 상태 코드와 함께 응답을 반환합니다 (본문 없음).

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ DELETE /messages/:id
       │ Authorization: Bearer {token}
       ▼
┌─────────────────────────────────────────────┐
│      MessagesController.remove()             │
│  ┌──────────────────────────────────────┐   │
│  │ 1. JwtAuthGuard                      │   │
│  │    - @CurrentUser() 추출             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 2. MessagesService.remove()          │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ 3. MessageRepository.findOne()       │   │
│  │    - relations: ['channel']          │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│         ┌───────┴───────┐                   │
│         │               │                    │
│         ▼               ▼                    │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 메시지 없음  │  │ 메시지 있음  │         │
│  │ 404 Not Found│  │ 계속 진행    │         │
│  └──────────────┘  └──────┬───────┘         │
│                            │                  │
│                  ┌─────────▼─────────┐        │
│                  │ authorId === userId│       │
│                  │ 권한 확인         │        │
│                  └─────────┬─────────┘        │
│                            │                  │
│                  ┌─────────┴─────────┐        │
│                  │                   │        │
│                  ▼                   ▼        │
│          ┌──────────────┐   ┌──────────────┐  │
│          │ 권한 없음    │   │ 권한 있음    │  │
│          │ 403 Forbidden│   │ 계속 진행    │  │
│          └──────────────┘   └──────┬───────┘  │
│                                    │          │
│                          ┌─────────▼─────────┐│
│                          │ ChannelRepository ││
│                          │ findOne()         ││
│                          │ + members         ││
│                          │ 멤버 확인         ││
│                          └─────────┬─────────┘│
│                                    │          │
│                          ┌─────────▼─────────┐│
│                          │ MessageRepository ││
│                          │ .remove()         ││
│                          └─────────┬─────────┘│
│                                    │          │
│                          ┌─────────▼─────────┐│
│                          │ SQLite DB         ││
│                          │ DELETE Message    ││
│                          └─────────┬─────────┘│
│                                    │          │
│                          ┌─────────▼─────────┐│
│                          │ MessagesGateway   ││
│                          │ broadcastDeletedMessage│
│                          └─────────┬─────────┘│
│                                    │          │
│                          ┌─────────▼─────────┐│
│                          │ WebSocket Clients ││
│                          │ emit('deletedMessage')│
│                          └─────────┬─────────┘│
└────────────────────────────────────┼──────────┘
                                     │
                                     ▼
                              ┌─────────────┐
                              │ 204 No Content│
                              └─────────────┘
```

---

## 모듈 간 상호작용 다이어그램

### 전체 시스템 아키텍처

#### 아키텍처 설명

Crew 프로젝트는 NestJS의 모듈 시스템을 기반으로 구성되어 있습니다:

- **Auth Module**: 인증 관련 기능을 담당합니다. JWT 토큰 생성, 검증, 사용자 인증을 처리합니다.
- **Users Module**: 사용자 관리 기능을 담당합니다. 사용자 CRUD 작업을 처리합니다.
- **Channels Module**: 채널 관리 기능을 담당합니다. 채널 생성, 수정, 삭제, 참여/탈퇴를 처리합니다.
- **Messages Module**: 메시지 관리 기능을 담당합니다. 메시지 CRUD 작업과 WebSocket 통신을 처리합니다.

각 모듈은 독립적으로 동작하지만, 필요에 따라 다른 모듈의 Service나 Entity를 사용합니다:
- Auth Module은 Users Module의 UserService를 사용합니다.
- Channels Module은 Users Module과 Auth Module을 의존합니다.
- Messages Module은 Users Module, Channels Module, Auth Module을 모두 의존합니다.

모든 모듈은 TypeORM을 통해 SQLite 데이터베이스와 통신합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      NestJS Application                          │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Auth       │  │    Users     │  │   Channels   │          │
│  │   Module     │  │   Module     │  │   Module     │          │
│  │              │  │              │  │              │          │
│  │ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │          │
│  │ │Controller│ │  │ │Controller│ │  │ │Controller│ │          │
│  │ └────┬─────┘ │  │ └────┬─────┘ │  │ └────┬─────┘ │          │
│  │      │       │  │      │       │  │      │       │          │
│  │ ┌────▼─────┐ │  │ ┌────▼─────┐ │  │ ┌────▼─────┐ │          │
│  │ │ Service  │ │  │ │ Service  │ │  │ │ Service  │ │          │
│  │ └────┬─────┘ │  │ └────┬─────┘ │  │ └────┬─────┘ │          │
│  │      │       │  │      │       │  │      │       │          │
│  │ ┌────▼─────┐ │  │ ┌────▼─────┐ │  │ ┌────▼─────┐ │          │
│  │ │  Guard   │ │  │ │Repository│ │  │ │Repository│ │          │
│  │ │ Strategy │ │  │ └────┬─────┘ │  │ └────┬─────┘ │          │
│  │ └──────────┘ │  │      │       │  │      │       │          │
│  └──────────────┘  └──────┼───────┘  └──────┼───────┘          │
│                            │                 │                   │
│                            └────────┬────────┘                   │
│                                     │                            │
│  ┌──────────────┐                  │                            │
│  │   Messages   │                  │                            │
│  │   Module     │                  │                            │
│  │              │                  │                            │
│  │ ┌──────────┐ │                  │                            │
│  │ │Controller│ │                  │                            │
│  │ └────┬─────┘ │                  │                            │
│  │      │       │                  │                            │
│  │ ┌────▼─────┐ │                  │                            │
│  │ │ Service  │ │                  │                            │
│  │ └────┬─────┘ │                  │                            │
│  │      │       │                  │                            │
│  │ ┌────▼─────┐ │                  │                            │
│  │ │ Gateway  │ │                  │                            │
│  │ │(WebSocket)│                  │                            │
│  │ └────┬─────┘ │                  │                            │
│  │      │       │                  │                            │
│  │ ┌────▼─────┐ │                  │                            │
│  │ │Repository│ │                  │                            │
│  │ └────┬─────┘ │                  │                            │
│  └──────┼───────┘                  │                            │
│         │                          │                            │
│         └──────────┬───────────────┘                            │
│                    │                                            │
│         ┌──────────▼──────────┐                                  │
│         │  TypeORM           │                                  │
│         │  Repository        │                                  │
│         └──────────┬─────────┘                                  │
│                    │                                            │
│         ┌──────────▼──────────┐                                  │
│         │   SQLite Database   │                                  │
│         │   (crew.db)         │                                  │
│         └────────────────────┘                                  │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

### 인증 흐름 상세

#### 인증 흐름 설명

JWT 기반 인증은 다음과 같은 단계로 진행됩니다:

1. **HTTP 요청 수신**: 클라이언트가 `Authorization` 헤더에 Bearer 토큰을 포함하여 요청을 전송합니다.

2. **CORS 및 ValidationPipe 처리**: 공통 미들웨어가 요청을 처리합니다.

3. **라우터**: NestJS 라우터가 요청을 해당 Controller로 라우팅합니다.

4. **JwtAuthGuard 실행**: `@UseGuards(JwtAuthGuard)` 데코레이터가 적용된 경우 Guard가 실행됩니다.
   - `Authorization` 헤더에서 `Bearer {token}` 형식의 토큰을 추출합니다.
   - 토큰이 없거나 형식이 잘못된 경우 인증 실패로 처리됩니다.

5. **JwtStrategy 실행**: Guard가 Strategy의 `validate()` 메서드를 호출합니다.
   - `JwtService.verify()`를 사용하여 토큰의 서명과 만료 시간을 검증합니다.
   - 토큰이 유효하지 않으면 인증 실패로 처리됩니다.

6. **페이로드 추출**: 검증된 토큰에서 페이로드를 추출합니다.
   - 페이로드에는 `sub` (사용자 ID), `email`, `username`이 포함됩니다.

7. **사용자 정보 주입**: `validate()` 메서드가 사용자 정보를 반환하면, Guard가 이를 `request.user`에 주입합니다.

8. **Controller 실행**: 인증이 완료되면 Controller 메서드가 실행됩니다.
   - `@CurrentUser()` 데코레이터를 사용하여 `request.user`에서 사용자 정보를 추출할 수 있습니다.

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ HTTP Request + Authorization Header
       ▼
┌─────────────────────────────────────────────┐
│         main.ts (Application)              │
│  ┌──────────────────────────────────────┐   │
│  │ CORS Middleware                       │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ ValidationPipe                       │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ Router → Controller                  │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ @UseGuards(JwtAuthGuard)             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ JwtAuthGuard                         │   │
│  │ - Extract Bearer Token               │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ JwtStrategy                          │   │
│  │ - verify(token, secret)              │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ validate(payload)                   │   │
│  │ - Extract user info                 │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ request.user = { userId, email, ... }│   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ Controller Method                    │   │
│  │ @CurrentUser() decorator             │   │
│  └──────────────┬───────────────────────┘   │
│                 │                            │
│  ┌──────────────▼───────────────────────┐   │
│  │ Service Method                       │   │
│  │ - Business Logic                     │   │
│  └──────────────────────────────────────┘   │
└──────────────────────────────────────────────┘
```

---

## 주요 모듈 의존성

#### 모듈 의존성 설명

NestJS의 모듈 시스템은 명확한 의존성 관계를 통해 구성됩니다:

**1. Auth Module (인증 모듈)**:
   - **의존성**: UsersModule, JwtModule, PassportModule
   - **역할**: JWT 토큰 생성 및 검증, 사용자 인증 처리
   - **제공**: JwtAuthGuard, JwtStrategy, @CurrentUser() 데코레이터
   - **사용**: UsersService를 사용하여 사용자 정보를 조회합니다.

**2. Users Module (사용자 모듈)**:
   - **의존성**: 없음 (최하위 모듈)
   - **역할**: 사용자 CRUD 작업, 사용자 정보 관리
   - **제공**: User Entity, UserService, UserRepository
   - **특징**: 다른 모듈들이 사용하는 기본 모듈입니다.

**3. Channels Module (채널 모듈)**:
   - **의존성**: UsersModule, AuthModule
   - **역할**: 채널 생성, 수정, 삭제, 참여/탈퇴 관리
   - **제공**: Channel Entity, ChannelsService, ChannelsController
   - **사용**: 
     - UsersModule의 UserService를 사용하여 사용자 정보를 조회합니다.
     - AuthModule의 JwtAuthGuard를 사용하여 인증을 처리합니다.

**4. Messages Module (메시지 모듈)**:
   - **의존성**: UsersModule, ChannelsModule, AuthModule
   - **역할**: 메시지 CRUD 작업, WebSocket 실시간 통신
   - **제공**: Message Entity, MessagesService, MessagesGateway
   - **사용**:
     - UsersModule의 UserService를 사용하여 작성자 정보를 조회합니다.
     - ChannelsModule의 ChannelsService를 사용하여 채널 정보를 조회합니다.
     - AuthModule의 JwtAuthGuard를 사용하여 인증을 처리합니다.

**5. TypeORM Module**:
   - **역할**: 모든 모듈이 공통으로 사용하는 데이터베이스 접근 계층
   - **제공**: Repository 패턴, 데이터베이스 연결 관리
   - **특징**: SQLite 데이터베이스와 통신하는 유일한 인터페이스입니다.

이러한 의존성 구조를 통해 모듈 간 결합도를 낮추고 재사용성을 높입니다.

```
┌─────────────────────────────────────────────────────────────┐
│                    Module Dependencies                      │
│                                                             │
│  ┌──────────────┐                                          │
│  │   Auth       │                                          │
│  │   Module     │                                          │
│  │              │                                          │
│  │ Depends on:  │                                          │
│  │ - UsersModule│                                          │
│  │ - JwtModule  │                                          │
│  │ - PassportModule│                                       │
│  └──────┬───────┘                                          │
│         │                                                   │
│         │ uses                                             │
│         ▼                                                   │
│  ┌──────────────┐                                          │
│  │   Users      │                                          │
│  │   Module     │                                          │
│  │              │                                          │
│  │ Provides:    │                                          │
│  │ - User Entity│                                          │
│  │ - UserService│                                          │
│  └──────┬───────┘                                          │
│         │                                                   │
│         │ uses                                             │
│         ▼                                                   │
│  ┌──────────────┐                                          │
│  │   Channels   │                                          │
│  │   Module     │                                          │
│  │              │                                          │
│  │ Depends on:  │                                          │
│  │ - UsersModule│                                          │
│  │ - AuthModule │ (for Guards)                            │
│  └──────┬───────┘                                          │
│         │                                                   │
│         │ uses                                             │
│         ▼                                                   │
│  ┌──────────────┐                                          │
│  │   Messages   │                                          │
│  │   Module     │                                          │
│  │              │                                          │
│  │ Depends on:  │                                          │
│  │ - UsersModule│                                          │
│  │ - ChannelsModule│                                       │
│  │ - AuthModule │ (for Guards)                            │
│  └──────┬───────┘                                          │
│         │                                                   │
│         │ all use                                          │
│         ▼                                                   │
│  ┌──────────────┐                                          │
│  │  TypeORM     │                                          │
│  │  Module      │                                          │
│  │              │                                          │
│  │ Provides:    │                                          │
│  │ - Repository │                                          │
│  │ - Connection │                                          │
│  └──────┬───────┘                                          │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────┐                                          │
│  │  SQLite DB   │                                          │
│  └──────────────┘                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름 예시: 메시지 생성 전체 흐름

```
┌─────────────┐
│   Client    │
│  (Frontend) │
└──────┬──────┘
       │ 1. POST /messages
       │    Authorization: Bearer {token}
       │    { content: "Hello", channelId: "123" }
       ▼
┌─────────────────────────────────────────────────────────────┐
│                    HTTP Layer                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ main.ts                                              │   │
│  │ - CORS 처리                                          │   │
│  │ - ValidationPipe                                      │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
│  ┌──────────────────▼───────────────────────────────────┐   │
│  │ Router → MessagesController.create()                  │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
│  ┌──────────────────▼───────────────────────────────────┐   │
│  │ JwtAuthGuard                                         │   │
│  │ - 토큰 검증                                          │   │
│  │ - @CurrentUser() → { userId: "user-123" }            │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
│  ┌──────────────────▼───────────────────────────────────┐   │
│  │ MessagesController.create()                          │   │
│  │ - DTO 검증 (CreateMessageDto)                        │   │
│  │ - MessagesService.create(dto, userId) 호출           │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                 Business Logic Layer                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ MessagesService.create()                             │   │
│  │                                                      │   │
│  │ 1. ChannelRepository.findOne(channelId)             │   │
│  │    └─> Channel + members 관계 로드                   │   │
│  │                                                      │   │
│  │ 2. 멤버 확인: userId in channel.members?            │   │
│  │    └─> 아니면 403 Forbidden                         │   │
│  │                                                      │   │
│  │ 3. UserRepository.findOne(userId)                   │   │
│  │    └─> 작성자 확인                                   │   │
│  │                                                      │   │
│  │ 4. MessageRepository.create() + save()              │   │
│  │    └─> 메시지 생성 및 저장                           │   │
│  │                                                      │   │
│  │ 5. MessageRepository.findOne() + relations          │   │
│  │    └─> author, channel 관계 로드                     │   │
│  │                                                      │   │
│  │ 6. toResponseDto()                                  │   │
│  │    └─> MessageResponseDto 변환                      │   │
│  │                                                      │   │
│  │ 7. MessagesGateway.broadcastNewMessage()            │   │
│  │    └─> WebSocket 브로드캐스트                        │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  Data Access Layer                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ TypeORM Repository                                    │   │
│  │                                                      │   │
│  │ ChannelRepository:                                    │   │
│  │   SELECT * FROM channels WHERE id = ?               │   │
│  │   JOIN channel_members ...                           │   │
│  │                                                      │   │
│  │ UserRepository:                                      │   │
│  │   SELECT * FROM users WHERE id = ?                   │   │
│  │                                                      │   │
│  │ MessageRepository:                                   │   │
│  │   INSERT INTO messages (content, authorId, ...)     │   │
│  │   SELECT * FROM messages WHERE id = ?               │   │
│  │   JOIN users ... JOIN channels ...                   │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Database Layer                            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ SQLite Database (crew.db)                            │   │
│  │                                                      │   │
│  │ Tables:                                              │   │
│  │ - users                                              │   │
│  │ - channels                                           │   │
│  │ - messages                                           │   │
│  │ - channel_members (join table)                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  WebSocket Layer                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ MessagesGateway                                      │   │
│  │                                                      │   │
│  │ broadcastNewMessage(channelId, message)             │   │
│  │   └─> socket.to(`channel-${channelId}`)            │   │
│  │       .emit('newMessage', message)                  │   │
│  │                                                      │   │
│  │ 모든 연결된 클라이언트에 실시간 알림 전송            │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                        │
└─────────────────────┼────────────────────────────────────────┘
                      │
                      ▼
┌─────────────┐
│   Client    │
│  (Response) │
└─────────────┘
   201 Created
   { id, content, author, channel, createdAt }
   
   + WebSocket Event: 'newMessage'
```

---

**마지막 업데이트**: 2026-01-27
